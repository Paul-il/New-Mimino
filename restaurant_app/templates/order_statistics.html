{% extends "base.html" %}
{% load static %}
{% load custom_tags %}
{% block title %}Order Statistics{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4" style="color: white;">Статистика Продаж</h1>
    {% if start_date and end_date %}
    <p style="color: white; font-size: 15px;">
        Статистика вычислена за период с {{ start_date }} по {{ end_date }}
    </p>
    <p style="color: white; font-size: 15px;">
        Общая сумма продаж: ₪{{ total_sales_value|floatformat:2 }}
    </p>
    {% else %}
        <p style="color: white; font-size: 15px;">Нет данных для отображения статистики.</p>
    {% endif %}

    <!-- Form for date range and day of week selection -->
    <form method="get" class="form-inline">
        {% csrf_token %}
        <div class="form-group mb-2">
            <select name="category" class="form-control" onchange="this.form.submit()">
                <option value="">Все категории</option>
                {% for category, display_name in product_categories %}
                <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ display_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mx-sm-3 mb-2">
            <label for="day_of_week">День недели:</label>
            <select name="day_of_week" id="day_of_week" class="form-control">
                {% for value, name in form.day_of_week.choices %}
                <option value="{{ value }}" {% if selected_day_of_week|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>            
        </div>        
        <button type="submit" class="btn btn-primary mb-2">Фильтровать</button>
    </form>

    <table id="orderStatisticsTableByProduct" class="table table-striped">
        <thead>
            <tr>
                <th scope="col" style="color: white; font-size: 15px;">Имя Продукта</th>
                <th scope="col" style="color: white; font-size: 15px;">Количество</th>
                <th scope="col" style="color: white; font-size: 15px;">Сумма (₪)</th>
                <th scope="col" style="color: white; font-size: 15px;">Процент от общих продаж</th>
            </tr>
        </thead>
        <tbody>
            {% for stats in product_statistics %}
                <tr>
                    <td>{{ stats.product__product_name_rus }}</td>
                    <td>{{ stats.total_quantity }}</td>
                    <td>{{ stats.total_price|floatformat:2 }}</td>
                    <td>{{ stats.percentage|floatformat:2 }}%</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    $(document).ready(function () {
        $('#orderStatisticsTableByProduct').DataTable({
            "order": [[2, 'desc']],  // Default sorting on the "Сумма" column
            "columnDefs": [
                { "type": "num", "targets": 2 } // Specify that the third column is numeric
            ]
        });
    });
</script>
{% endblock %}
