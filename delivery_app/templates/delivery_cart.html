{% extends "base.html" %}
{% load custom_tags %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">

{% block title %}Информация о заказе на Доставку{% endblock %}

{% block content %}
<div class="container">
    <div class="my-4">
        <a href="{% url 'delivery_app:delivery_menu' delivery_phone_number=delivery_phone_number category='salads' %}" class="btn btn-primary">Меню</a>
    </div>
  <h1 class="my-4" style="color: white;">Информация о заказе на Доставку</h1>
  <p style="color: white; font-size: 20px;">Номер Телефона: {{ delivery_phone_number }}</p>
  <p style="color: white; font-size: 20px;">Имя: {{ customer_name }}</p>
  <table class="table">
    <thead>
        <tr>
            <th scope="col" style="color: white; font-size: 26px;">Название</th>
            <th scope="col" style="color: white; font-size: 26px;">Количество</th>
            <th scope="col" style="color: white; font-size: 26px;">Цена</th>
            <th scope="col" style="color: white; font-size: 26px;">Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for item in cart_items %}
    <tr>
        <td style="color: rgb(231, 235, 5);">{{ item.product.product_name_rus }}</td>
        <td id="order-item-{{ item.id }}-quantity" style="color: white;">{{ item.quantity|append_grams:item.product.product_name_rus }}</td>
        <td style="color: rgb(255, 255, 255);">{{ item.product.product_price }}₪</td>
        <td>
              
                <div class="d-inline-block">
                    <form method="POST" action="{% url 'delivery_app:delivery_increase_product' delivery_phone_number item.product.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="hidden" name="product_id" value="{{ item.product.id }}">
                        <button type="submit" class="btn1 btn-danger btn-sm">Добавить</button>
                    </form>
                </div>
                <div class="d-inline-block">
                    <form method="POST" action="{% url 'delivery_app:delivery_decrease_product' delivery_phone_number item.product.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="hidden" name="product_id" value="{{ item.product.id }}">
                        <button type="submit" class="btn1 btn-danger btn-sm">Убавить</button>
                    </form>
                </div>
                

              <form method="POST" action="{% url 'delivery_app:delivery_remove_product' delivery_phone_number item.product.id %}">
                {% csrf_token %}
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <input type="hidden" name="product_id" value="{{ item.product.id }}">
                <td><button type="submit" class="btn1 btn-danger btn-sm">Удалить</button></td>
              </form>
              
            </td>
          </tr>
          
          
        
        {% endfor %}
        
    </tbody>
      
</table>
<div class="d-flex justify-content-between align-items-center">
  <p style="color: white;">Общая сумма: {{ cart|delivery_total_price }}₪</p>
  <form method="get" action="{% url 'delivery_app:delivery_menu' delivery_phone_number=delivery_phone_number category='delivery'%}">
      <input type="hidden" name="category" value="delivery">
      <button type="submit" class="btn btn-primary">Выбор Стоимости Доставки.</button>
  </form>
  <div></div>  <!-- Этот пустой div поможет отцентровать кнопку посередине -->
</div>


<label class="form-group d-flex" style="color: rgb(238, 4, 4); font-size: 26px;">Метод Оплаты:</label>
<div class="flex-container align-items-center">

    <div class="payment-section d-flex flex-column align-items-center">

        <form action="{% url 'delivery_app:delivery_generate_pdf' delivery_phone_number=delivery_phone_number order_id=delivery_order.id %}" method="post">
            {% csrf_token %}
            <div class="form-check" style="margin: 0;">
                <input class="form-check-input" type="radio" name="payment_method" id="cash" value="cash">
                <label class="form-check-label mr-3" for="cash" style="color: rgb(238, 4, 4);">
                    Наличные
                </label>
            </div>
            <div class="form-check" style="margin: 0;">
                <input class="form-check-input" type="radio" name="payment_method" id="credit_card" value="credit_card">

                <label class="form-check-label mr-3" for="credit_card" style="color: rgb(238, 4, 4);">
                    Кредитная карта
                </label>
            </div>
            <button id="pay-button" type="button" class="btn2 btn-primary2 mr-3">Счет Оплачен.</button>
            <input type="hidden" name="courier" id="selected-courier">
        </form>
    </div>
    
    <button type="button" id="print-kitchen" name="print-kitchen" class="btn-primary2">Подтвердить Заказ.</button>
    <form hx-post="{% url 'delivery_app:delivery_pdf_template' phone_number=delivery_phone_number order_id=delivery_order.id %}" method="post">
        {% csrf_token %}
        <button type="button" id="print-bill" name="print-bill" class="btn-primary2" value="Распечатать Счет." onclick="printInvoice('{{ delivery_phone_number }}', '{{ delivery_order.id }}'); return false;">Распечатать Счет.</button>
    </form>
</div>


<!-- Модальное окно для выбора курьера -->
<div id="courierModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Выберите курьера</h2>
    <form method="POST" action="{% url 'delivery_app:set_courier' delivery_phone_number=delivery_phone_number %}">
        {% csrf_token %}
        <div class="form-check">
            <input class="form-check-input" type="radio" name="courier" id="our_courier" value="our_courier">
            <label class="form-check-label" for="our_courier">Наш Курьер</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="courier" id="solo" value="solo">
            <label class="form-check-label" for="solo">Соло</label>
        </div>
        <button type="submit" name="set-courier-button" value="set-courier-button" class="btn btn-primary mt-2" disabled>Установить курьера</button>
    </form>
  </div>
</div>


<script src="https://unpkg.com/htmx.org/dist/htmx.min.js"></script>


{% block head_extra %}  <!-- Добавьте этот блок, чтобы убедиться, что стили добавляются в head документа -->
    <style>
/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
    background-color: #fefefe;
    margin: 15% auto; /* 15% from the top and centered */
    padding: 20px;
    border: 1px solid #888;
    width: 80%; /* Could be more or less, depending on screen size */
}

/* The Close Button */
.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

/* Цвет текста для имен курьеров */
.modal-content .form-check-label {
            color: black;
        }

        .flex-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.payment-section {
    display: flex;
    align-items: center;
    gap: 20px; /* расстояние между элементами */
}

</style>


{% endblock %}


<script>
    var modal = document.getElementById("courierModal");
var btn = document.getElementById("pay-button");
var radioButtons = document.querySelectorAll('#courierModal input[type="radio"]');
var setCourierButton = document.querySelector('#courierModal button[name="set-courier-button"]');

// Добавьте обработчик события для каждой радио-кнопки
radioButtons.forEach(function(radioButton) {
    radioButton.addEventListener('change', function() {
        // Если одна из радио-кнопок выбрана, активируйте кнопку "Установить курьера"
        if (this.checked) {
            setCourierButton.disabled = false;
        }
    });
});

// При клике на кнопку "Счет Оплачен", проверяем выбран ли метод оплаты.
// Если выбран, то показываем модальное окно для выбора курьера.
btn.onclick = function() {
    var paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    if (!paymentMethod) {
        alert('Выберите способ оплаты!');
        return;  // Если способ оплаты не выбран, просто завершаем функцию
    }
    console.log("Payment method selected");
    modal.style.display = "block";
}

// После выбора курьера и нажатия на кнопку в модальном окне, закрываем модальное окно 
// и отправляем форму с методом оплаты.
document.querySelector('#courierModal form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    var selectedCourier = document.querySelector('#courierModal input[name="courier"]:checked');
    if (selectedCourier) {
        document.getElementById('selected-courier').value = selectedCourier.value;
    }
    
    console.log("Courier selected");
    modal.style.display = "none";
    document.querySelector('.payment-section form').submit();
});  // Здесь была проблема

// Предотвратить закрытие модального окна при клике вне его
window.onclick = function(event) {
    if (event.target === modal) {
        event.stopPropagation();
    }
}
</script>


<script>
    function setDeliveryPrice(price) {
        document.getElementById("delivery-price").value = price;
        calculateTotalPrice();
    }
</script>


<script>
    var cashInput = document.getElementById('cash');
    var creditCardInput = document.getElementById('credit_card');
    var payButton = document.getElementById('pay-button');
    
    cashInput.addEventListener('change', handlePaymentMethodChange);
    creditCardInput.addEventListener('change', handlePaymentMethodChange);
    
    function handlePaymentMethodChange() {
        payButton.removeAttribute('disabled');
    }
</script>

    
<script>
    function printInvoice(phoneNumber, orderId) {
      var printWindow = window.open('', '', 'height=600,width=800,hidden');
    
      // Отправляем запрос на сервер для загрузки pdf_template.html
      fetch(`/delivery_pdf_template/${phoneNumber}/${orderId}/`, {
        method: 'GET',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      })
      .then(response => response.text())
      .then(html => {
        // Загружаем HTML в новое окно
        printWindow.document.write(html);
    
        // Вызываем функцию печати для нового окна через 2 секунды
        setTimeout(function() {
          printWindow.print();
    
          // Закрываем окно печати через 30 секунд
          setTimeout(function() {
            printWindow.close();
          }, 1);
        }, 500);
    
        // Добавляем обработчик события onbeforeunload
        printWindow.onbeforeunload = function() {
          printWindow.close();
        };
      }); 
    }
        </script>


<script>
  document.getElementById('print-kitchen').addEventListener('click', function() {
      var phone = '{{ delivery_phone_number }}';
      var orderId = '{{ delivery_order.id }}';
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '{% url "delivery_app:print_kitchen" %}?phone_number=' + phone + '&order_id=' + orderId);
      xhr.onload = function() {
          if (xhr.status === 200) {
              var response = JSON.parse(xhr.responseText);
              alert(response.message);
          }
      };
      xhr.send();
  });
</script>


{% endblock %}